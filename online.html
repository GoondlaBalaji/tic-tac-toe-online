<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tic-Tac-Toe: KA-POW Online (Upgraded)</title>

  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Permanent+Marker&family=Kalam:wght@400;700&display=swap" rel="stylesheet">

  <!-- Tone loaded as a classic script (global) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

  <style>
  /* ---------------- Theme variables ---------------- */
  :root{
    --font-bangers: 'Bangers', cursive;
    --font-marker: 'Permanent Marker', cursive;
    --font-handwritten: 'Kalam', cursive;

    --color-ink: #1a1a1a;
    --color-paper: #f5f5f0;
    --accent-x: #FF4500;
    --accent-o: #1E90FF;
    --accent-green: #32CD32;
    --win-line: #32CD32;

    --panel-stroke-width: 6px;
    --shadow-ink: rgba(0,0,0,0.85);
  }

  /* ---------------- Reset / base ---------------- */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background-color:var(--color-paper);
    color:var(--color-ink);
    font-family:var(--font-handwritten);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    overflow:hidden;

    /* Halftone background texture */
    background-image:
      radial-gradient(var(--color-ink) 0.5px, transparent 0.5px),
      radial-gradient(var(--color-ink) 0.5px, var(--color-paper) 0.5px);
    background-size: 12px 12px;
    background-position: 0 0, 6px 6px;
  }

  .dramatic-bg {
    background: radial-gradient(circle, rgba(0,0,0,0.25) 2px, transparent 2px),
                radial-gradient(circle, rgba(0,0,0,0.15) 2px, var(--color-paper) 2px);
    background-size: 22px 22px;
    background-position: 0 0, 11px 11px;
  }

  /* -------------- Main panel -------------- */
  #panel {
    width:95%;
    max-width:680px;
    padding:30px;
    background:var(--color-paper);
    border: var(--panel-stroke-width) solid var(--color-ink);
    box-shadow: 18px 18px 0 var(--shadow-ink);
    transform: skewX(-3deg);
    position:relative;
    transition: all 0.3s ease-out;
    margin: 18px;
  }
  #panel > * { transform: skewX(3deg); } /* counter-skew children */

  #title {
    font-family:var(--font-bangers);
    font-size: clamp(2.4rem, 6vw, 4.2rem);
    color: var(--accent-x);
    text-align:center;
    margin: 0 0 12px 0;
    text-shadow: 4px 4px 0 var(--color-ink), -2px -2px 0 var(--accent-x);
  }

  #status {
    font-family:var(--font-marker);
    font-size:1.2rem;
    text-align:center;
    margin-bottom:18px;
    padding:10px;
    border:2px dashed var(--color-ink);
    background: rgba(255,255,255,0.85);
    min-height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* -------------- Board -------------- */
  #board {
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: var(--panel-stroke-width);
    width:100%;
    aspect-ratio:1/1;
    background-color:var(--color-ink);
    position:relative;
    border-radius:6px;
    overflow:hidden;
  }

  .cell {
    background:var(--color-paper);
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:var(--font-marker);
    font-size: clamp(2.6rem, 8vw, 5.4rem);
    cursor:pointer;
    user-select:none;
    transition: background-color 0.12s ease;
    position:relative;
    overflow:hidden;
    border:2px solid var(--color-ink);
  }
  .cell:hover{ background:#efefef }

  .cell .piece{
    opacity:0;
    transform: scale(0.5) rotate(360deg);
    transition: transform 0.35s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.25s ease;
    line-height:1;
  }
  .cell.x-played .piece{
    color:var(--accent-x);
    transform: scale(1) rotate(0deg);
    opacity:1;
    text-shadow: 5px 5px 0 var(--color-ink), -2px -2px 0 var(--accent-x);
    animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  }
  .cell.o-played .piece{
    color:var(--accent-o);
    transform: scale(1) rotate(0deg);
    opacity:1;
    text-shadow: 5px 5px 0 var(--color-ink), -2px -2px 0 var(--accent-o);
    animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  }

  @keyframes popIn{
   0% { transform: scale(0) rotate(360deg); opacity:0 }
   50%{ transform: scale(1.5) rotate(-10deg); opacity:1 }
   100%{ transform: scale(1) rotate(0); opacity:1 }
  }

  /* -------------- Explosion particles -------------- */
  .explosion{
    position:absolute;
    width:10px;height:10px;border-radius:50%;
    background:currentColor;
    animation: explode 0.55s forwards ease-out;
    opacity:0;
    z-index:5;
    pointer-events:none;
  }
  @keyframes explode{
    0% { transform: translate(-50%,-50%) scale(1); opacity:1 }
    100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity:0 }
  }

  /* -------------- Win line & pulsing cells -------------- */
  #board::before{
    content:''; position:absolute;
    z-index:10;
    background: var(--win-line);
    opacity:0;
    transform: translate(-50%,-50%) scale(0);
    transition: opacity .45s, transform .45s;
    box-shadow: 0 0 20px var(--win-line);
    border:4px solid var(--color-ink);
  }
  .win-line-active{ opacity:1 !important; transform: translate(-50%,-50%) scale(1) !important; }

  .row0-win::before { width: 90%; height: 20px; top: 16.66%; left: 50%; }
  .row1-win::before { width: 90%; height: 20px; top: 50%; left: 50%; }
  .row2-win::before { width: 90%; height: 20px; top: 83.33%; left: 50%; }

  .col0-win::before { width: 20px; height: 90%; top: 50%; left: 16.66%; }
  .col1-win::before { width: 20px; height: 90%; top: 50%; left: 50%; }
  .col2-win::before { width: 20px; height: 90%; top: 50%; left: 83.33%; }

  .diag0-win::before { width: 120%; height: 20px; top: 50%; left: 50%;
    transform: translate(-50%,-50%) rotate(45deg) scale(1.05); }
  .diag1-win::before { width: 120%; height: 20px; top: 50%; left: 50%;
    transform: translate(-50%,-50%) rotate(-45deg) scale(1.05); }

  .cell.winning-cell{
    animation: winningPulse 0.5s infinite alternate;
    background-color: var(--win-line) !important;
    border-color: var(--win-line) !important;
  }
  .cell.winning-cell .piece{
    color:var(--color-ink) !important;
    text-shadow: 2px 2px 0 var(--color-paper), -2px -2px 0 var(--color-paper);
  }

  @keyframes winningPulse{
    from { box-shadow: 0 0 10px var(--win-line) }
    to { box-shadow: 0 0 25px var(--win-line),
         0 0 35px var(--color-paper) }
  }

  /* -------------- Controls -------------- */
  .controls{
    margin-top:15px;
    display:flex;
    gap:8px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
    transform:skewX(3deg);
  }
  .btn{
    font-family:var(--font-bangers);
    font-size:1.1rem;
    padding:10px 18px;
    background:var(--accent-green);
    color:var(--color-paper);
    border:4px solid var(--color-ink);
    box-shadow:4px 4px 0 var(--color-ink);
    cursor:pointer;
    transition:all .12s;
    text-shadow:2px 2px 0 var(--color-ink);
  }
  .btn:hover{
    transform: translate(2px,2px);
    box-shadow:2px 2px 0 var(--color-ink);
  }
  .btn-red{ background:#ff7a7a }

  #room-code{
    padding:6px 10px;
    border:4px solid var(--color-ink);
    background:#fff;
    font-family:var(--font-marker);
  }

  /* -------------- Game Over Overlay -------------- */
  #game-over-overlay{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(26,26,26,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20;
    perspective:1000px;
    flex-direction:column;
    cursor:default;
  }

  .game-over-message{
    font-family:var(--font-bangers);
    font-size: clamp(2.4rem, 10vw, 4.8rem);
    color:var(--accent-x);
    padding:16px;
    background:var(--color-paper);
    border:8px double var(--color-ink);
    box-shadow:10px 10px 0 var(--color-ink);
    transform: scale(0) rotateX(90deg);
    animation: messagePop .75s forwards cubic-bezier(.175,.885,.32,1.275);
    text-align:center;
    line-height:1.05;
    margin-bottom:12px;
  }

  @keyframes messagePop{
    0% { transform: scale(0) rotateX(90deg); opacity:0 }
    70% { transform: scale(1.12) rotateX(-5deg); opacity:1 }
    100% { transform: scale(1) rotateX(0deg); opacity:1 }
  }

  /* -------------- Sound effect text -------------- */
  #sound-effect-display{
    position: fixed;
    left:50%; top:50%;
    transform: translate(-50%,-50%) scale(0.5);
    font-family:var(--font-bangers);
    font-size: clamp(2.6rem, 10vw, 6rem);
    color:var(--accent-x);
    text-shadow: 5px 5px 0 var(--color-ink), -5px -5px 0 var(--color-ink);
    padding:8px 16px;
    pointer-events:none;
    z-index:9999;
    opacity:0;
    transition: transform .28s cubic-bezier(.175,.885,.32,1.275),
                opacity .2s ease;
    text-transform:uppercase;
  }

  #sound-effect-display.show{
    opacity:1;
    transform: translate(-50%,-50%) scale(1) rotate(5deg);
    animation: shake .32s ease-in-out;
  }

  @keyframes shake{
    0% { transform: translate(-50%,-50%) scale(1) rotate(5deg) }
    25% { transform: translate(-52%,-52%) scale(1.05) rotate(-3deg) }
    50% { transform: translate(-48%,-48%) scale(1) rotate(5deg) }
    75% { transform: translate(-51%,-51%) scale(1.05) rotate(-3deg) }
    100% { transform: translate(-50%,-50%) scale(1) rotate(5deg) }
  }

  /* -------------- GIF Overlay -------------- */
  #gif-showcase-overlay {
    position: fixed;
    top:0; left:0;
    width:100vw;
    height:100vh;
    background: black;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
    overflow:hidden;
  }
  #gif-showcase-image {
    height:100vh;
    width:auto;
    object-fit:cover;
  }

  .hidden{ display:none !important }
  </style>
</head>

<body class="dramatic-bg">
  <div id="panel">

    <div id="title">TIC-TAC-TOE: KA-POW ONLINE</div>

    <div id="status">Connecting...</div>

    <div id="board">
      <div class="cell" data-i="0"></div>
      <div class="cell" data-i="1"></div>
      <div class="cell" data-i="2"></div>
      <div class="cell" data-i="3"></div>
      <div class="cell" data-i="4"></div>
      <div class="cell" data-i="5"></div>
      <div class="cell" data-i="6"></div>
      <div class="cell" data-i="7"></div>
      <div class="cell" data-i="8"></div>
    </div>

    <div class="controls">
      <div id="room-code"></div>
      <button id="restart" class="btn">Start New Arc</button>
      <button id="leave" class="btn btn-red">Leave</button>
    </div>

    <div id="game-over-overlay">
      <div class="game-over-message" id="overlay-message"></div>
      <div id="gif-button-container"></div>
    </div>

  </div>

  <div id="sound-effect-display"></div>

  <div id="gif-showcase-overlay">
    <img id="gif-showcase-image" src="" alt="Fight Scene GIF">
  </div>


<!-- ⭐⭐⭐ PART 1 ENDS HERE — Next message will contain PART 2 (JS begins) ⭐⭐⭐ -->
<script type="module">
/* ------------------ FIREBASE IMPORTS ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getDatabase,
  ref,
  set,
  update,
  onValue,
  get,
  runTransaction,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* ------------------ FIREBASE CONFIG ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyBOipyswkPf2Tcdd_j46GnypfsAREixjmE",
  authDomain: "tic-tac-toe-952af.firebaseapp.com",
  databaseURL: "https://tic-tac-toe-952af-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tic-tac-toe-952af",
  storageBucket: "tic-tac-toe-952af.appspot.com",
  messagingSenderId: "336489066886",
  appId: "1:336489066886:web:737bb1f0e2b7ead0017c07"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ------------------ DOM ELEMENTS ------------------ */
const panelEl = document.getElementById('panel');
const statusEl = document.getElementById('status');
const boardEl = document.getElementById('board');
const cells = Array.from(document.querySelectorAll('.cell'));
const restartBtn = document.getElementById('restart');
const leaveBtn = document.getElementById('leave');
const roomCodeBox = document.getElementById('room-code');
const overlay = document.getElementById('game-over-overlay');
const overlayMessage = document.getElementById('overlay-message');
const soundDisplay = document.getElementById('sound-effect-display');
const gifButtonContainer = document.getElementById('gif-button-container');
const gifShowcaseOverlay = document.getElementById('gif-showcase-overlay');
const gifShowcaseImage = document.getElementById('gif-showcase-image');

/* ------------------ URL / STATE ------------------ */
const qs = new URLSearchParams(location.search);
const mode = qs.get('mode');        // room_host or room_join
const urlCode = qs.get('code');     // room code in url

let roomCode = null;
let roomRef = null;
let player = null; // 'X' or 'O'
let gameActive = false;

let currentBoard = ["","","","","","","","",""];
let currentResult = "";

/* ------------------ Winning conditions -------------- */
const winningConditions = [
  [0,1,2,'row0-win'], [3,4,5,'row1-win'], [6,7,8,'row2-win'],
  [0,3,6,'col0-win'], [1,4,7,'col1-win'], [2,5,8,'col2-win'],
  [0,4,8,'diag0-win'], [2,4,6,'diag1-win']
];

/* ------------------ GIF scenes ------------------ */
const fightScenes = [
  { name: "CRITICAL HOOK", file: "animation/ani3.gif" },
  { name: "WHIP ATTACK", file: "animation/ani2.gif" },
  { name: "DUELING STRINGS", file: "animation/ani5.gif" },
  { name: "SAMURAI CHARGE", file: "animation/ani7.gif" },
  { name: "AXE PARRY", file: "animation/ani6.gif" },
  { name: "RISING UPPERCUT", file: "animation/ani1.gif" },
  { name: "SPEED PUNCH", file: "animation/ani4.gif" }
];

/* ------------------ Audio Setup ------------------ */
const hasTone = typeof window !== 'undefined' && !!window.Tone;
const ToneLib = hasTone ? window.Tone : null;

let xSynth = { triggerAttackRelease: ()=>{} };
let oSynth = { triggerAttackRelease: ()=>{} };
let winSynth = { triggerAttackRelease: ()=>{} };
let drawNoise = { triggerAttackRelease: ()=>{} };

if (ToneLib) {
  try {
    xSynth = new ToneLib.Synth({
      oscillator: { type: "sine" },
      envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.3 }
    }).toDestination();

    oSynth = new ToneLib.AMSynth({
      harmonicity: 2,
      detune: 0,
      oscillator: { type: "sawtooth" },
      envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.5 },
      modulation: { type: "square" }
    }).toDestination();

    winSynth = new ToneLib.PolySynth(ToneLib.Synth, {
      oscillator: { type: "triangle" },
      envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 3.0 },
      volume: -6
    }).toDestination();

    drawNoise = new ToneLib.NoiseSynth({
      noise: { type: "pink" },
      envelope: { attack: 0.005, decay: 0.5, sustain: 0, release: 0.01 }
    }).toDestination();
    drawNoise.volume.value = -10;
  } catch(err) {
    console.warn("Tone initialization failed:", err);
  }
}

let audioEnabled = false;
function enableAudioOnFirstGesture() {
  if (!audioEnabled && ToneLib) {
    ToneLib.start()
      .then(() => audioEnabled = true)
      .catch(err => {
        audioEnabled = false;
        console.warn("Tone.start() failed:", err);
      });
  }
}
document.body.addEventListener('pointerdown', enableAudioOnFirstGesture, { once: true });
restartBtn.addEventListener('pointerdown', enableAudioOnFirstGesture, { once: true });

/* ------------------ Sound Visual FX ------------------ */
function showSoundEffect(text, color) {
  soundDisplay.textContent = text;
  soundDisplay.style.color = color;
  soundDisplay.style.textShadow =
    `5px 5px 0 var(--color-ink), -5px -5px 0 ${color}`;
  soundDisplay.classList.add('show');

  const xOffset = Math.random()*40 - 20;
  const yOffset = Math.random()*40 - 20;
  soundDisplay.style.transform =
     `translate(calc(-50% + ${xOffset}px), calc(-50% + ${yOffset}px)) scale(1) rotate(5deg)`;

  setTimeout(() => soundDisplay.classList.remove('show'), 700);
}

function playMoveSound(piece) {
  if (!audioEnabled) return;

  if (piece === "X") {
    try { xSynth.triggerAttackRelease("C5", "8n"); } catch{}
    showSoundEffect("KA-CHINK!", "var(--accent-x)");
  } else {
    try { oSynth.triggerAttackRelease("G3", "4n"); } catch{}
    showSoundEffect("WHUMP!", "var(--accent-o)");
  }
}

function playWinSound() {
  if (!audioEnabled) return;
  try {
    winSynth.triggerAttackRelease(["C4","E4","G4","C5"], "2n");
  } catch {}
  showSoundEffect("KABOOM!", "var(--win-line)");
}

function playDrawSound() {
  if (!audioEnabled) return;
  try { drawNoise.triggerAttackRelease("0.5"); } catch {}
  showSoundEffect("STALEMATE!", "var(--color-ink)");
}

/* ------------------ Explosion FX ------------------ */
function createExplosion(cellEl, piece) {
  const computed = getComputedStyle(document.documentElement);
  const color =
    piece === 'X'
      ? computed.getPropertyValue('--accent-x').trim()
      : computed.getPropertyValue('--accent-o').trim();

  for (let i=0;i<10;i++){
    const p = document.createElement('div');
    p.className = 'explosion';
    p.style.color = color;

    const angle = Math.random()*Math.PI*2;
    const distance = Math.random()*110 + 20;
    const dx = Math.cos(angle)*distance;
    const dy = Math.sin(angle)*distance;
    p.style.setProperty('--dx', `${dx}px`);
    p.style.setProperty('--dy', `${dy}px`);
    p.style.top = '50%';
    p.style.left = '50%';

    cellEl.appendChild(p);
    setTimeout(() => p.remove(), 700);
  }
}

/* ------------------ Board Rendering ------------------ */
function drawBoard(board) {
  const safeBoard = Array.isArray(board)
    ? board
    : ["","","","","","","","",""];

  let movedIndex = -1;
  let movedPiece = null;

  cells.forEach((cell, i) => {
    const oldPiece = currentBoard[i];
    const newPiece = safeBoard[i];

    if (oldPiece !== newPiece && newPiece !== "") {
      movedIndex = i;
      movedPiece = newPiece;
    }

    cell.className = 'cell';
    cell.innerHTML = "";

    if (newPiece !== "") {
      cell.classList.add(`${newPiece.toLowerCase()}-played`);
      cell.innerHTML = `<span class="piece">${newPiece}</span>`;
    }
  });

  if (movedIndex !== -1 && currentBoard.some(v => v !== "")) {
    const movedCell = cells[movedIndex];
    createExplosion(movedCell, movedPiece);
    playMoveSound(movedPiece);
  }

  currentBoard = [...safeBoard];
}

/* ------------------ GIF Showcase ------------------ */
function showGifScene(gifFile) {
  if (!gifFile) return;
  gifShowcaseImage.src = gifFile;
  gifShowcaseOverlay.style.display = 'flex';
}

/* ------------------ Local Win Check ------------------ */
function checkLocalWin(board, marker) {
  for (const [a,b,c,line] of winningConditions) {
    if (board[a]===marker && board[b]===marker && board[c]===marker) {
      return { isWin: true, lineClass: line, cells:[a,b,c] };
    }
  }
  return { isWin:false, lineClass:null, cells:[] };
}

/* ------------------ Create GIF Buttons ------------------ */
function createGifButtons(outcome, winner) {
  gifButtonContainer.innerHTML = "";
  const iAmWinner = (player === winner);

  if (outcome === "win") {
    if (iAmWinner) {
      const gifBtn = document.createElement("button");
      gifBtn.classList.add("btn");
      gifBtn.style.backgroundColor = "var(--accent-x)";
      gifBtn.textContent = "SHOW FINAL SCENE!";

      gifBtn.addEventListener("click", async (e) => {
        e.stopPropagation();

        const r = Math.floor(Math.random()*fightScenes.length);
        const chosen = fightScenes[r].file;

        await safeUpdateRoom({ gif_action: chosen });
        gifBtn.disabled = true;
        gifBtn.textContent = "Scene Playing...";
      });

      gifButtonContainer.appendChild(gifBtn);
    } else {
      const msg = document.createElement("div");
      msg.style.color = "white";
      msg.style.fontFamily = "var(--font-marker)";
      msg.textContent = "Winner is choosing the final scene...";
      gifButtonContainer.appendChild(msg);
    }
  }

  if (outcome === "draw") {
    const msg = document.createElement("div");
    msg.style.color = "white";
    msg.textContent = "It's a draw!";
    gifButtonContainer.appendChild(msg);
  }

  if (player === "X") {
    const restartBtnLocal = document.createElement("button");
    restartBtnLocal.classList.add("btn");
    restartBtnLocal.textContent = "START NEW ARC";
    restartBtnLocal.addEventListener("click", restartGame);
    gifButtonContainer.appendChild(restartBtnLocal);
  }
}

/* ------------------ Safe DB Update ------------------ */
async function safeUpdateRoom(obj) {
  if (!roomRef) return;
  try {
    await update(roomRef, obj);
  } catch(e){
    console.error("safeUpdateRoom error:", e);
  }
}

/* ------------------ Cell Click Handling ------------------ */
cells.forEach(cell => {
  cell.addEventListener('click', async () => {
    if (!gameActive || currentResult) return;
    if (!roomRef || !player) return;

    const index = Number(cell.dataset.i);

    try {
      await runTransaction(roomRef, room => {
        if (!room) return room;
        if (room.result) return room;
        if (room.turn !== player) return room;
        if (!Array.isArray(room.board)) room.board = ["","","","","","","","",""];
        if (room.board[index] !== "") return room;

        room.board[index] = player;

        const wins = [
          [0,1,2],[3,4,5],[6,7,8],
          [0,3,6],[1,4,7],[2,5,8],
          [0,4,8],[2,4,6]
        ];

        for (const [a,b,c] of wins) {
          if (room.board[a] &&
              room.board[a] === room.board[b] &&
              room.board[a] === room.board[c]) {
            room.result = player;
            room.turn = "";
            return room;
          }
        }

        if (!room.board.includes("")) {
          room.result = "draw";
          room.turn = "";
          return room;
        }

        room.turn = (player === "X" ? "O" : "X");
        return room;
      });
    } catch(err) {
      console.error("move failed:", err);
    }
  });
});
/* ------------------ Main DB Listener ------------------ */
function startListening() {
  if (!roomRef) { setStatus("Invalid room", "red"); return; }

  onValue(roomRef, snap => {
    const data = snap.val();
    if (!data) {
      if (roomCode) {
        alert("Room closed by opponent.");
        location.href = "mode.html";
      }
      return;
    }

    /* ⭐⭐⭐ AUTO-REFRESH GUEST WHEN HOST RESTARTS ⭐⭐⭐ */
    if (data.restart_flag === true) {

      // Guest reloads instantly
      if (player === "O") {
        location.reload();
        return;
      }

      // Host clears the flag
      if (player === "X") {
        update(roomRef, { restart_flag: false });
      }
    }

    /* ---------------- Opponent left ---------------- */
    if ((player === 'X' && !data.guestPresent) ||
        (player === 'O' && !data.hostPresent)) {

      setStatus("Opponent left the room.", "red");
      gameActive = false;
      overlay.style.display = 'none';
      return;
    }

    /* ---------------- GIF Action ---------------- */
    if (data.gif_action) {
      try { showGifScene(data.gif_action); } catch{}
      if (player === "X") {
        setTimeout(() => {
          safeUpdateRoom({ gif_action: null });
        }, 1500);
      }
    }

    /* ---------------- Win / Draw Logic ---------------- */
    if (data.result && data.result !== currentResult) {
      gameActive = false;
      currentResult = data.result;

      // reset visuals
      cells.forEach(c => c.classList.remove('winning-cell'));
      const winClasses = [
        'row0-win','row1-win','row2-win',
        'col0-win','col1-win','col2-win',
        'diag0-win','diag1-win','win-line-active'
      ];
      winClasses.forEach(cls => boardEl.classList.remove(cls));
      panelEl.classList.remove('game-ending');

      if (data.result === "draw") {
        playDrawSound();
        setStatus("It's a DRAW!", "var(--color-ink)");
        panelEl.classList.add('game-ending');

        setTimeout(() => {
          overlayMessage.textContent = "DRAW!";
          overlay.style.display = "flex";
          overlayMessage.style.color = "var(--color-ink)";
          createGifButtons("draw");
        }, 450);

      } else {
        const winner = data.result;
        const color = (winner === "X")
          ? "var(--accent-x)"
          : "var(--accent-o)";

        setStatus("Player " + winner + " WINS! (KABOOM!)", color);
        playWinSound();

        const winInfo = checkLocalWin(data.board, winner);
        if (winInfo.isWin) {
          boardEl.classList.add(winInfo.lineClass);
          setTimeout(() =>
            boardEl.classList.add("win-line-active"), 50);
          winInfo.cells.forEach(i =>
            cells[i].classList.add("winning-cell"));
        }

        panelEl.classList.add('game-ending');
        setTimeout(() => {
          overlayMessage.textContent = winner + " WINS!";
          overlay.style.display = "flex";
          overlayMessage.style.color = color;
          createGifButtons("win", winner);
        }, 450);
      }
    }

    /* ---------------- Draw Board ---------------- */
    drawBoard(data.board || ["","","","","","","","",""]);

    /* ---------------- Standard State ---------------- */
    if (!data.result) {
      gameActive = true;
      currentResult = "";
      if (data.turn === player) {
        const color = (player === "X")
          ? "var(--accent-x)" : "var(--accent-o)";
        setStatus("Your turn (" + player + ")", color);
      } else {
        setStatus("Opponent's turn");
      }
    }
  });
}

/* ------------------ Utility ------------------ */
function setStatus(text, color="black") {
  statusEl.textContent = text;
  statusEl.style.color = color;
}
function getRoomRef(code) {
  return ref(db, "rooms/" + code);
}

/* ------------------ HOST Restart Logic ------------------ */
async function restartGame() {
  if (!roomRef) return;
  if (player !== "X") {
    alert("Only host can restart!");
    return;
  }

  try {
    const snap = await get(roomRef);
    if (!snap.exists() || !snap.val().guestPresent) {
      alert("Cannot restart: Opponent missing.");
      return;
    }

    /* ⭐ IMPORTANT ⭐
       Set restart_flag so guest reloads automatically */
    await update(roomRef, {
      board: ["","","","","","","","",""],
      turn: "X",
      result: "",
      gif_action: null,
      restart_flag: true,
      updatedAt: Date.now()
    });

    // HOST does NOT refresh — only resets UI locally
    overlay.style.display = "none";
    overlayMessage.textContent = "";
    gifButtonContainer.innerHTML = "";

    currentBoard = ["","","","","","","","",""];
    currentResult = "";
    gameActive = true;

    resetBoardVisuals();

    cells.forEach(c => {
      c.innerHTML = "";
      c.className = "cell";
    });

    setStatus("Your turn (X)", "var(--accent-x)");

  } catch(err) {
    console.error("Restart failed:", err);
  }
}
restartBtn.addEventListener("click", restartGame);

/* ------------------ Leave Room ------------------ */
leaveBtn.addEventListener("click", async () => {
  if (!roomRef) {
    location.href = "mode.html";
    return;
  }

  try {
    if (player === "X") {
      await set(roomRef, null);
    } else {
      await update(roomRef, {
        guestPresent: false,
        updatedAt: Date.now()
      });
    }
  } catch(err) {
    console.error("Leave failed:", err);
  }

  location.href = "mode.html";
});

/* ------------------ GIF Overlay Close ------------------ */
gifShowcaseOverlay.addEventListener('click', () => {
  gifShowcaseOverlay.style.display = "none";
  gifShowcaseImage.src = "";
});

/* ------------------ BOOT: host/join logic ------------------ */
async function boot() {
  if (!mode || !urlCode) {
    setStatus("Invalid room link", "red");
    return;
  }

  roomCode = urlCode.toUpperCase();
  roomRef = getRoomRef(roomCode);
  roomCodeBox.textContent = "ROOM: " + roomCode;

  const snap = await get(roomRef);

  /* ---------- HOST ---------- */
  if (mode === "room_host") {

    if (!snap.exists()) {
      await set(roomRef, {
        board:["","","","","","","","",""],
        turn:"X",
        result:"",
        hostPresent:true,
        guestPresent:false,
        gif_action:null,
        restart_flag:false,
        updatedAt: Date.now()
      });
    } else {
      await update(roomRef, {
        hostPresent:true,
        updatedAt: Date.now()
      });
    }

    player = "X";
    setStatus("Waiting for guest...", "var(--accent-x)");

    try {
      const od = onDisconnect(roomRef);
      if (od && od.remove) od.remove();
    } catch {}

    startListening();
    return;
  }

  /* ---------- GUEST ---------- */
  if (mode === "room_join") {

    if (!snap.exists()) {
      alert("Room not found");
      location.href = "mode.html";
      return;
    }

    const data = snap.val();
    if (data.guestPresent) {
      alert("Room already has a guest.");
      location.href="mode.html";
      return;
    }

    await update(roomRef, {
      guestPresent:true,
      updatedAt: Date.now()
    });

    try {
      const odg = onDisconnect(ref(db, "rooms/" + roomCode + "/guestPresent"));
      if (odg && odg.set) odg.set(false);
    } catch{}

    player = "O";
    setStatus("Joined — You are O", "var(--accent-o)");
    startListening();
    return;
  }

  setStatus("Invalid mode", "red");
}

/* ------------------ Helpers ------------------ */
function resetBoardVisuals() {
  const allWinClasses = [
    'row0-win','row1-win','row2-win',
    'col0-win','col1-win','col2-win',
    'diag0-win','diag1-win','win-line-active'
  ];
  allWinClasses.forEach(cls => boardEl.classList.remove(cls));

  cells.forEach(c => c.classList.remove('winning-cell'));
  panelEl.classList.remove('game-ending');
  boardEl.style.transform = "";
}

/* ------------------ Start Game ------------------ */
boot();
</script>
</body>
</html>

